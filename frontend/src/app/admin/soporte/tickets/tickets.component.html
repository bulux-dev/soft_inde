<div class="content">

  <div class="page-header">
    <div class="page-title">
      <h4>Tickets</h4>
      <h6>Control de Tickets</h6>
    </div>
    <div class="page-btn">
      <a id="btn_agregar" class="btn btn-added" data-bs-toggle="offcanvas" data-bs-target="#abrir-ticket">
        <i class="fa fa-plus me-2"></i>
        Agregar Ticket
      </a>
    </div>
  </div>

  <div class="row">

    <div class="col-lg-12">

      <div class="row chat-window">

        <!-- Chat User List -->
        <div class="col-lg-5 col-xl-4 chat-cont-left">
          <div class="card mb-sm-3 mb-md-0 contacts_card flex-fill">
            <div class="card-header chat-search">
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="search_btn"><i class="fas fa-search"></i></span>
                </div>
                <input type="text" placeholder="Search" class="form-control search-chat rounded-pill">
              </div>
            </div>
            <div class="card-body contacts_body chat-users-list chat-scroll">
              @for (t of tickets; track t.id) {
              <a href="javascript:void(0);" class="media d-flex" [ngClass]="{'active': t.estado == 'Cerrado'}"
                (click)="setTicket(t)">
                <div class="media-img-wrap flex-shrink-0">
                  <div class="avatar"
                    [ngClass]="{'avatar-online': t.estado == 'Abierto', 'avatar-offline': t.estado == 'Cerrado'}">
                    <img src="assets/img/avatar.png" alt="User Image" class="avatar-img rounded-circle">
                  </div>
                </div>
                <div class="media-body flex-grow-1">
                  <div>
                    <div class="user-name">{{t.asunto}}</div>
                    <div class="user-last-chat text-start">{{t.usuario.nombre}} {{t.usuario.apellido}}</div>
                  </div>
                  <div>
                    <div class="last-chat-time">{{t.fecha | hace}}</div>
                    <div class="badge badge-pill"
                      [ngClass]="{'bg-success': t.estado == 'Abierto', 'bg-danger': t.estado == 'Cerrado'}">{{t.estado}}
                    </div>
                  </div>
                </div>
              </a>
              }
            </div>
          </div>
        </div>
        <!-- Chat User List -->

        <div class="col-lg-7 col-xl-8 chat-cont-right">

          @if (ticket && !isMobile) {
          <div class="card mb-0">
            <div class="card-header msg_head">
              <div class="d-flex bd-highlight">
                <a id="back_user_list" href="javascript:void(0)" class="back-user-list">
                  <i class="fas fa-chevron-left"></i>
                </a>
                <div class="img_cont">
                  <img class="rounded-circle user_img" src="assets/img/avatar.png" alt="">
                </div>
                <div class="user_info">
                  <span><strong id="receiver_name">Ticket #{{ticket?.id}}</strong></span>
                  <p class="mb-0">{{ticket?.usuario.nombre}} {{ticket?.usuario.apellido}}</p>
                </div>
                <div class="ms-auto">
                  <div class="input-group">
                    <!-- <a (click)="deleteTicket(ticket.id)" href="javascript:void(0);" class="btn btn- btn-sm btn-outline-danger">
                      <i style="font-size: 12px;" class="fas fa-trash"></i>
                    </a> -->
                    <a (click)="closeTicket(ticket)" href="javascript:void(0);"
                      class="btn btn- btn-sm btn-outline-success" style="width: 100px;"
                      [ngClass]="{'disabled': ticket?.estado == 'Cerrado'}">
                      <i style="font-size: 12px;" class="fas fa-check"></i> Cerrar Ticket
                    </a>
                  </div>
                </div>
              </div>
            </div>

            <div class="card-body msg_card_body chat-scroll">

              @if (ticket && ticket?.error) {
              <span>
                <strong>Fecha:</strong> {{ticket?.error.fecha}} <br>
                <strong>Tipo:</strong> {{ticket?.error.tipo}} <br>
                <strong>Url:</strong> {{ticket?.error.url}} <br>
                <strong>Params:</strong> {{ticket?.error.params}} <br>
                <strong>Body:</strong> {{ticket?.error.body}} <br>
                <strong>Mensaje:</strong> {{ticket?.error.mensaje}} <br>
                <strong>Dispostivo:</strong> {{ticket?.error.dispositivo}} <br>
                <hr>
              </span>
              }
              <p class="mb-0"><strong>Asunto:</strong> {{ticket?.asunto}}</p>
              <div [innerHTML]="ticket?.descripcion"></div>
              <br>

              <ul class="list-unstyled">
                <li class="chat-date">{{ticket?.fecha | hace: 'DD/MM/YYYY HH:mm'}}</li>

                @for (t of ticket?.tickets_mensajes; track t;) {
                <li class="media received d-flex"
                  [ngClass]="{'sent': t.usuario_id == usuario_id, 'received': t.usuario_id != usuario_id}">
                  <div class="avatar flex-shrink-0">
                    <img src="assets/img/avatar.png" alt="User Image" class="avatar-img rounded-circle">
                  </div>
                  <div class="media-body flex-grow-1">
                    <div class="msg-box">
                      <div>
                        <p [id]="'msg' + $index">
                          {{t.mensaje}}
                        </p>
                        <ul class="chat-msg-info">
                          <li>
                            <div class="chat-time">
                              <span>{{t.fecha | hace: 'DD/MM/YYYY HH:mm'}}</span>
                            </div>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </li>
                }

                @if (ticket?.estado == 'Cerrado') {
                <li class="chat-date text-danger">Ticket Cerrado</li>
                }
              </ul>

            </div>

            <!-- <div class="card-footer">
                <textarea id="editor-detalle" placeholder="Agrega una entrada al ticket..."></textarea>
                <br>
                <div class="text-end">
                  <button id="enviar" (click)="postTicketMensaje()" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> Enviar
                  </button>
                </div>
              </div> -->

            <div class="card-footer" [ngClass]="{'disabled': ticket?.estado == 'Cerrado'}">
              <div class="input-group">
                <input id="input-mensaje" class="form-control type_msg mh-auto empty_check"
                  placeholder="Agrega una entrada al ticket..." [(ngModel)]="mensaje"
                  [ngModelOptions]="{standalone: true}" (keydown.enter)="postTicketMensaje()" enterkeyhint="enter">
                <button id="enviar" (click)="postTicketMensaje()" class="btn btn-primary btn_send"
                  [ngClass]="{'disabled': !mensaje}">
                  <i class="fa fa-paper-plane" aria-hidden="true"></i>
                </button>
              </div>
            </div>

          </div>
          } @else {

          <div class="text-center">
            <img id="robot" class="mt-3" width="400" src="https://api.kairosgt.com/public/robots/perfil.png">
            <br>
            <h4 class="mb-3">Selecciona un ticket</h4>
          </div>
          }

        </div>

      </div>

    </div>

  </div>

</div>


<div class="offcanvas offcanvas-end" tabindex="-1" id="abrir-ticket">
  <div class="offcanvas-header">
    <h5 class="m-0">Nuevo Ticket</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <form [formGroup]="ticketForm">
      <div class="mb-3">
        <label for="asunto" class="form-label">Asunto</label>
        <input type="text" class="form-control" id="asunto" formControlName="asunto" placeholder="Descripción corta">
      </div>
      <div class="mb-3">
        <label for="descripcion" class="form-label">Descripción</label>
        <textarea id="editor" name="editor" placeholder="Describe el problema de forma detallada..."></textarea>
      </div>
      <div class="text-end">
        <button (click)="postTicket()" class="btn btn-primary">
          <i class="fas fa-paper-plane"></i> Abrir Ticket
        </button>
      </div>
    </form>
  </div>
</div>


<div class="offcanvas offcanvas-end" tabindex="-1" id="detalle-ticket">
  <div class="offcanvas-header">
    <h5 class="m-0">TicketChat</h5>
    <button (click)="ticket = null" type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"
      aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <div class="chat-window">
      <div class="chat-cont-right">
        <div class="card mb-0">
          <div class="card-header msg_head">
            <div class="d-flex bd-highlight">
              <a id="back_user_list" href="javascript:void(0)" class="back-user-list">
                <i class="fas fa-chevron-left"></i>
              </a>
              <div class="img_cont">
                <img class="rounded-circle user_img" src="assets/img/avatar.png" alt="">
              </div>
              <div class="user_info">
                <span><strong id="receiver_name">Ticket #{{ticket?.id}}</strong></span>
                <p class="mb-0">{{ticket?.usuario.nombre}}</p>
              </div>
              <div class="ms-auto">
                <div class="input-group">
                  <!-- <a (click)="deleteTicket(ticket.id)" href="javascript:void(0);" class="btn btn- btn-sm btn-outline-danger">
                    <i style="font-size: 12px;" class="fas fa-trash"></i>
                  </a> -->
                  <a (click)="closeTicket(ticket)" href="javascript:void(0);"
                    class="btn btn- btn-sm btn-outline-success" style="width: 100px;"
                    [ngClass]="{'disabled': ticket?.estado == 'Cerrado'}">
                    <i style="font-size: 12px;" class="fas fa-check"></i> Cerrar Ticket
                  </a>
                </div>
              </div>
            </div>
          </div>

          <div class="card-body msg_card_body chat-scroll">

            @if (ticket && ticket?.error) {
            <span>
              <strong>Fecha:</strong> {{ticket?.error.fecha}} <br>
              <strong>Tipo:</strong> {{ticket?.error.tipo}} <br>
              <strong>Url:</strong> {{ticket?.error.url}} <br>
              <strong>Params:</strong> {{ticket?.error.params}} <br>
              <strong>Body:</strong> {{ticket?.error.body}} <br>
              <strong>Mensaje:</strong> {{ticket?.error.mensaje}} <br>
              <strong>Dispostivo:</strong> {{ticket?.error.dispositivo}} <br>
              <hr>
            </span>
            }
            <p class="mb-0"><strong>Asunto:</strong> {{ticket?.asunto}}</p>
            <div [innerHTML]="ticket?.descripcion"></div>
            <br>

            <ul class="list-unstyled">
              <li class="chat-date">{{ticket?.fecha | hace: 'DD/MM/YYYY HH:mm'}}</li>

              @for (t of ticket?.tickets_mensajes; track t;) {
              <li class="media received d-flex"
                [ngClass]="{'sent': t.usuario_id == usuario_id, 'received': t.usuario_id != usuario_id}">
                <div class="avatar flex-shrink-0">
                  <img src="assets/img/avatar.png" alt="User Image" class="avatar-img rounded-circle">
                </div>
                <div class="media-body flex-grow-1">
                  <div class="msg-box">
                    <div>
                      <p [id]="'msg' + $index">
                        {{t.mensaje}}
                      </p>
                      <ul class="chat-msg-info">
                        <li>
                          <div class="chat-time">
                            <span>{{t.fecha | hace: 'DD/MM/YYYY HH:mm'}}</span>
                          </div>
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
              </li>
              }

              @if (ticket?.estado == 'Cerrado') {
              <li class="chat-date text-danger">Ticket Cerrado</li>
              }
            </ul>

          </div>

          <!-- <div class="card-footer">
              <textarea id="editor-detalle" placeholder="Agrega una entrada al ticket..."></textarea>
              <br>
              <div class="text-end">
                <button id="enviar" (click)="postTicketMensaje()" class="btn btn-primary">
                  <i class="fas fa-paper-plane"></i> Enviar
                </button>
              </div>
            </div> -->

          <div class="card-footer" [ngClass]="{'disabled': ticket?.estado == 'Cerrado'}">
            <div class="input-group">
              <input id="input-mensaje" class="form-control type_msg mh-auto empty_check"
                placeholder="Agrega una entrada al ticket..." [(ngModel)]="mensaje"
                [ngModelOptions]="{standalone: true}" (keydown.enter)="postTicketMensaje()" enterkeyhint="enter">
              <button id="enviar" (click)="postTicketMensaje()" class="btn btn-primary btn_send"
                [ngClass]="{'disabled': !mensaje}">
                <i class="fa fa-paper-plane" aria-hidden="true"></i>
              </button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>