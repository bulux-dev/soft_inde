<div class="content">
  <div class="page-header">
    <div class="page-title">
      <h4>Creditos</h4>
      <h6>Control de creditos</h6>
    </div>
    <div class="page-btn">
      <a class="btn btn-added" routerLink="agregar" permiso="agregar-credito">
        <i class="fa fa-plus me-2"></i>
        Agregar Credito
      </a>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <div class="table-top">
        <div class="search-set">
          <div class="row">
            <div class="col-lg-4 col-6">
              <div class="form-group">
                <input class="form-control" type="datetime-local" [(ngModel)]="fecha_inicio"
                  [ngModelOptions]="{standalone: true}" (input)="getCreditos()">
              </div>
            </div>
            <div class="col-lg-4 col-6">
              <div class="form-group">
                <input class="form-control" type="datetime-local" [(ngModel)]="fecha_fin"
                  [ngModelOptions]="{standalone: true}" (input)="getCreditos()">
              </div>
            </div>
            <div class="col-lg-3 col-10">
              <div class="form-group">
                <input class="form-control" [(ngModel)]="busqueda" [ngModelOptions]="{standalone: true}"
                  (input)="search()" placeholder="Buscar...">
              </div>
            </div>
            <div class="col-lg-1 col-2 order-lg-first">
              <a class="btn btn-filter" id="filter_search">
                <img src="assets/img/icons/filter.svg" alt="img">
                <span>
                  <img src="assets/img/icons/closes.svg" alt="img">
                </span>
              </a>
            </div>
          </div>
        </div>
        <div class="wordset">
          <ul>
            <li>
              <button class="btn btn-primary" id="filter_search">
                <i class="fa fa-filter"></i>
              </button>
            </li>
          </ul>
        </div>
      </div>

      <div class="card" id="filter_inputs">
        <div class="card-body pb-0">
          <form [formGroup]="filtros" (ngSubmit)="getCreditos()" class="row">
            <div class="col-lg-2 col-sm-6 col-12">
              <div class="form-group">
                <input class="form-control" type="date" formControlName="fecha">
              </div>
            </div>
            <div class="col" class="text-end">
              <div class="form-group" style="float: right; margin-left: 10px;">
                <button type="submit" class="btn btn-filters ms-auto">
                  <img src="assets/img/icons/search-whites.svg" alt="img">
                </button>
              </div>
              <div class="form-group">
                <button type="button" class="btn btn-filters ms-auto" (click)="filtros.reset()" (click)="getCreditos()">
                  <i class="fa-solid fa-broom-wide"></i>
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>No.</th>
              <th>Fecha</th>
              <th>Cliente</th>
              <th>Proyecto</th>
              <th>Lote</th>
              <th>Asesor</th>
              <th>Total</th>
              <th>Estado</th>
              <th class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (c of creditos; track c.id) {
            <tr>
              <td>
                <a class="text-secondary" (click)="openDoc(c)">
                  #{{c.id}}
                </a>
              </td>
              <td>{{formatoFecha(c.fecha, 'DD/MM/yyyy HH:mm')}}</td>
              <td>{{c.credito_detalle.compr_nombre}}</td>
              <td>{{c.credito_detalle.categoria.nombre}}</td>
              <td>{{c.credito_detalle.producto.nombre}}</td>
              <td>{{c.credito_detalle.empleado.nombre}} {{c.credito_detalle.empleado.apellido}}</td>
              <td><b style="font-weight: 600;">{{c.total | number: '.2-2'}}</b></td>
              <td>
                <span class="badges"
                  [ngClass]="{'bg-success': c.estado == 'VIGENTE', 'bg-warning': c.estado == 'PENDIENTE', 'bg-danger': c.estado == 'ANULADO', 'bg-primary': c.estado == 'CANCELADO'}">{{c.estado}}
                </span>
              </td>
              <td class="text-end">
                <a class="me-2" (click)="credito = c" (click)="getDocumentos()" data-bs-toggle="offcanvas"
                  data-bs-target="#documentos" [hidden]="c.estado != 'PENDIENTE'">
                  <i class="fa-duotone fa-circle-check"></i>
                </a>
                <a class="me-2" [routerLink]="['amortizaciones', c.id]">
                  <i class="fa-solid fa-sack-dollar"></i>
                </a>
                <a class="me-2" (click)="credito = c" data-bs-toggle="modal" data-bs-target="#impresiones">
                  <i class="fas fa-print"></i>
                </a>
                <a class="me-2" permiso="editar-credito">
                  <i class="fas fa-pencil-alt" [routerLink]="['editar', c.id]"></i>
                </a>
                <a class="me-2" (click)="anularCredito(c)" [ngClass]="{'disabled': c.estado == 'ANULADO'}"
                  permiso="anular-credito">
                  <i class="fas fa-cancel"></i>
                </a>
                <a class="me-2" (click)="deleteCredito(c)" permiso="eliminar-credito">
                  <i class="fas fa-trash-alt"></i>
                </a>
              </td>
            </tr>
            } @empty {
              <tr>
                <td colspan="9" class="text-center">
                  <img id="robot" class="fa-bounce mt-3" width="100"
                    src="https://api.kairosgt.com/public/robots/busqueda.png">
                  <br>
                  <h4 class="mb-3">No se encontraron registros</h4>
                </td>
              </tr>
              }
          </tbody>
        </table>
      </div>

    </div>
  </div>

</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="doc">
  <div class="offcanvas-header">
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body" style="text-align: center;">
    @if (url) {
    <embed style="width: 100%; height: 100vh;" [src]="url" type="">
    }
  </div>
</div>

<div class="modal fade" id="impresiones" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Seleccione Impresion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-12">
            <ul style="margin-left: 20px;">
              <li type="disc" class="nav-item">
                <a class="nav-link" (click)="openCotizacion(credito)">
                  <p><u>Cotizacion</u></p>
                </a>
              </li>
              <li type="disc" class="nav-item">
                <a class="nav-link" (click)="openDoc(credito)">
                  <p><u>Proyeccion</u></p>
                </a>
              </li>
              <li type="disc" class="nav-item">
                <a class="nav-link" (click)="openSolicitud(credito)">
                  <p><u>Promesa</u></p>
                </a>
              </li>
              <li type="disc" class="submenu">
                <a class="nav-link" (click)="toggleInput()">
                  <p><u>Estado de Cuenta</u></p>
                </a>
                <ul>
                  <li
                    [ngStyle]="{ 'display': mostrarInput ? 'block' : 'none', 'margin-left': '15px', 'line-height': '20px' }">
                    <input class="form-control" type="month" [(ngModel)]="fecha_fin"
                      [ngModelOptions]="{standalone: true}" (change)="openEstadoCuenta(credito)">
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="documentos">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" style="margin-top: 15px;">Selecciona un Documento</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <hr size="3">
  <div class="offcanvas-body" style="text-align: center;">
    <div class="row">

      @for (d of documentos; track d.id) {
      <div class="col-6">
        <a [routerLink]="['../ventas/agregar', d.id, 'credito', credito.id]" target="_parent">
          <i class="fad fa-file-invoice-dollar fa-6x" [ngStyle]="{'color': d.color}"></i>
          <br>
          <p>
            <span [ngStyle]="{'color': d.color}">{{d.serie}}-{{d.correlativo}}</span>
            <br>
            {{d.nombre}}
          </p>
          <br>
        </a>
      </div>
      } @empty {
      <div class="col-12" style="text-align: center; margin-top: 50px;">
        <h6>No existen documentos creados</h6>
      </div>
      }
    </div>
  </div>
</div>